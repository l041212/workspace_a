<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>话务统计报表</title>

    <link rel="stylesheet" type="text/css" th:href="@{/plugins/report/css/nav.css}" >
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/report/css/iconfont.css}" >
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/plugins/bootstrapTable/css/bootstrap-table.min.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/font-awesome.min.css}" >
    <link rel="stylesheet" type="text/css" th:href="@{/css/smartadmin-production.min.css}" >
    <link rel="stylesheet" type="text/css" th:href="@{/css/smartadmin-production-plugins.min.css}" >
    <link rel="stylesheet" th:href="@{/plugins/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css}">
</head>
<body class="smart-style-0 desktop-detected" style="cursor: auto;">
<div class="nav">
    <div class="nav-top">
        <div id="mini" ><img th:src="@{/plugins/report/images/mini.png}" ></div>
    </div>
    <ul>
        <li class="nav-item ">
            <a href="#"><i class="my-icon nav-icon icon_1"></i><span>录音列表</span><i class="my-icon nav-more"></i></a>
            <ul>
                <li><a href="/record"><span>录音收藏夹</span></a></li>
            </ul>
        </li>
        <li class="nav-item nav-show">
            <a href="#"><i class="my-icon nav-icon icon_2"></i><span>统计报表</span><i class="my-icon nav-more"></i></a>
            <ul>
                <li><a href="/report_total_everydays"><span>总体话务量日报表</span></a></li>
                <li><a href="/report_total_months"><span>总体话务量月报表</span></a></li>
                <li><a href="/report_total_years"><span>总体话务量年报表</span></a></li>
                <li><a href="/report_total_agent"><span>坐席话务量报表</span></a></li>
                <li><a href="/report_evaluate_agent"><span>坐席话务评价报表</span></a></li>
                <li><a href="/report_average_agent"><span>坐席人均话务报表</span></a></li>
                <li><a href="#"><span>坐席话务量日统计报表</span></a></li>
            </ul>
        </li>
        <li class="nav-item">
            <a href="javascript:;"><i class="my-icon nav-icon icon_3"></i><span>明细表</span><i class="my-icon nav-more"></i></a>
            <ul>
                <li><a href="/agent_call_detail"><span>坐席话务明细表</span></a></li>
                <li><a href="/agent_status_detail"><span>坐席状态明细表</span></a></li>
            </ul>
        </li>
    </ul>
</div>

<div id="main" role="main">
    <div id="content">
        <section id="widget-grid" >
            <div class="row">
                <article class="col-xs-12">
                    <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">
                        <header>
                            <h2><strong>总体话务量日报表</strong></h2>
                        </header>
                        <div>
                            <div class="widget-body">
                                <form class="smart-form">
                                    <fieldset>
                                        <div class="row">
                                            <section class="col col-5">
                                                <label class="input"> <i class="icon-append fa fa-calendar"></i>
                                                    <input name="startDate" id="startDate" placeholder="开始时间" type="text" date-type="time" data-date-format="yyyy-mm-dd">
                                                </label>
                                            </section>
                                            <section class="col col-5">
                                                <label class="input"> <i class="icon-append fa fa-calendar"></i>
                                                    <input name="endDate" id="endDate" placeholder="结束时间" type="text" date-type="time" data-date-format="yyyy-mm-dd">
                                                </label>
                                            </section>
                                            <section class="col col-2">
                                                <a  class="btn btn-primary" id="searchReport" style="height: 32px;padding-top: 5px;width: 90px;"><strong>
                                                    <i class="fa fa-search"></i>
                                                    搜索</strong>
                                                </a>
                                            </section>
                                        </div>
                                    </fieldset>
                                </form>
                                <hr >
                                <div id="toolbar" class="btn-group" >
                                    <button id="exportBtn" class="export-excel btn btn-default" data-table="#report_total_everyday_table">
                                        <span class="glyphicon glyphicon-cloud-download" ></span>导出数据
                                    </button>
                                </div>
                                <table id="report_total_everyday_table"></table>
                                <hr >
                                <form class="smart-form">
                                    <fieldset>
                                        <div class="row">
                                            <section class="col col-4">
                                                <label class="input"> <i class="icon-append fa fa-calendar"></i>
                                                    <input name="date1" id="date1" placeholder="开始时间" type="text" date-type="time" data-date-format="yyyy-mm">
                                                </label>
                                            </section>
                                        </div>
                                    </fieldset>
                                </form>
                                <div class="" style="display: block; opacity: 1; height:400px ;" id="report_everyday">
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
        </section>
    </div>
</div>
<script th:src="@{/js/jquery-2.1.4.min.js}"></script>
<script th:src="@{/js/jquery-ui.min.js}"></script>
<script type="text/javascript" th:src="@{/plugins/report/js/nav.js}" ></script>
<script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrapTable/js/bootstrap-table.min.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrapTable/js/bootstrap-table-zh-CN.min.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrapTable/js/table-export.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrapTable/js/tableExport.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrapTable/js/jquery.base64.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrapTable/js/main.js}"></script>
<script type="text/javascript" th:src="@{/js/jarvis.widget.min.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrap-datetimepicker/bootstrap-datetimepicker.js}"></script>
<script type="text/javascript" th:src="@{/plugins/bootstrap-datetimepicker/bootstrap-datetimepicker.zh-CN.js}"></script>
<script type="text/javascript" th:src="@{/plugins/echarts/echarts.min.js}"></script>
<script type="text/javascript" th:src="@{/plugins/echarts/westeros.js}"></script>
<script>
    $(function () {
        $('#report_total_everyday_table').bootstrapTable({
            url : "/table_total_everydays",  //请求后台的URL（*）
            method : "POST" , //请求方式（*）
            contentType:"application/x-www-form-urlencoded; charset=UTF-8",
            toolbar : "#toolbar" , //工具按钮用哪个容器
            striped: true , //是否显示行间隔色
            cache: false ,  //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            pagination: true , //是否显示分页（*）
            sortable: true ,  //是否启用排序
            sortOrder: "asc" , //排序方式
            sidePagination: "server" , //分页方式：client客户端分页，server服务端分页（*）
            queryParamsType : "limit" ,
            pageNumber: 1 , //初始化加载第一页，默认第一页
            pageSize: 10 , //每页的记录行数（*）
            pageList: [10, 25, 50, 100] , //可供选择的每页的行数（*）
            search: false , //是否显示表格搜索，此搜索是客户端搜索，不会进服务端
            strictSearch: false ,
            showColumns: true , //是否显示所有的列
            showRefresh: false , //是否显示刷新按钮
            minimumCountColumns: 2 , //最少允许的列数
            clickToSelect: true , //是否启用点击选中行
            uniqueId: "date" , //每一行的唯一标识，一般为主键列
            showToggle: false , //是否显示详细视图和列表视图的切换按钮
            cardView: false ,   //是否显示详细视图
            detailView: false ,
            queryParams : function(params){
                var temp = {
                    limit : params.limit ,
                    page : params.offset  ,
                    keywords : params.search ,
                    sort : params.sort ,
                    order : params.order,
                    pageNumber : this.pageNumber,
                    pageSize : this.pageSize
                }
                return temp;
            } ,     //传递参数（*）
            columns: [{
                field : 'date',
                title : "日期",
                align: 'center',
                valign: 'middle',
                sortable:true
            },{
                field : 'sumCallIn',
                title : "呼入总量",
                align: 'center',
                valign: 'middle',
                sortable:true
            },{
                field : 'sumSuccessCallIn',
                title : "呼入接听量",
                align: 'center',
                valign: 'middle',
                sortable:true
            },{
                field : 'callOutCount',
                title : "呼出量",
                align: 'center',
                valign: 'middle',
                sortable:true
            },{
                field : 'successCallOutCount',
                title : "呼出接听量",
                align: 'center',
                valign: 'middle'
            },{
                field : 'avgTalkTime' ,
                title : "平均通话时长",
                align: 'center',
                valign: 'middle'
            },{
                field : 'avgQueueTime' ,
                title : "平均排队时长",
                align: 'center',
                valign: 'middle'
            },{
                field : 'avgAfterTime' ,
                title : "平均处理时长",
                align: 'center',
                valign: 'middle'
            },{
                field : 'avgRingTime' ,
                title : "平均震铃时长",
                align: 'center',
                valign: 'middle'
            },{
                field : 'sumCallInTime' ,
                title : "通话时长",
                align: 'center',
                valign: 'middle'
            },{
                field : 'sumQueueTime' ,
                title : "排队时长",
                align: 'center',
                valign: 'middle'
            }],
            showExport:true,
            exportDataType: "all",              //basic', 'all', 'selected'.
            exportTypes:['xlsx'],
            //
            // exportButton: $('#exportBtn'),
            exportOptions:{
                //ignoreColumn: [0,0],            //忽略某一列的索引
                fileName: '导出报表',              //文件名称设置
                worksheetName: 'Sheet1',          //表格工作区名称
                // tableName: '商品数据表',
                excelstyles: ['background-color', 'color', 'font-size', 'font-weight'],
                //onMsoNumberFormat: DoOnMsoNumberFormat
            },
            onLoadSuccess: function(){  //加载成功时执行
            }
        });
        TableExport.init();
        $.fn.jarvisWidgets && $("#widget-grid").jarvisWidgets({
            grid: "article",
            widgets: ".jarviswidget",
            localStorage: true,
            deleteSettingsKey: "#deletesettingskey-options",
            settingsKeyLabel: "Reset settings?",
            deletePositionKey: "#deletepositionkey-options",
            positionKeyLabel: "Reset position?",
            sortable: !0,
            buttonsHidden: !1,
            toggleButton: !0,
            toggleClass: "fa fa-minus | fa fa-plus",
            toggleSpeed: 200,
            onToggle: function() {},
            deleteButton: !0,
            deleteMsg: "Warning: This action cannot be undone!",
            deleteClass: "fa fa-times",
            deleteSpeed: 200,
            onDelete: function() {},
            editButton: !0,
            editPlaceholder: ".jarviswidget-editbox",
            editClass: "fa fa-cog | fa fa-save",
            editSpeed: 200,
            onEdit: function() {},
            colorButton: !0,
            fullscreenButton: !0,
            fullscreenClass: "fa fa-expand | fa fa-compress",
            fullscreenDiff: 3,
            onFullscreen: function() {},
            customButton: !1,
            customClass: "folder-10 | next-10",
            customStart: function() {
                alert("Hello you, this is a custom button...")
            },
            customEnd: function() {
                alert("bye, till next time...")
            },
            buttonOrder: "%refresh% %custom% %edit% %toggle% %fullscreen% %delete%",
            opacity: 1,
            dragHandle: "> header",
            placeholderClass: "jarviswidget-placeholder",
            indicator: !0,
            indicatorTime: 600,
            ajax: !0,
            timestampPlaceholder: ".jarviswidget-timestamp",
            timestampFormat: "Last update: %m%/%d%/%y% %h%:%i%:%s%",
            refreshButton: !0,
            refreshButtonClass: "fa fa-refresh",
            labelError: "Sorry but there was a error:",
            labelUpdated: "Last Update:",
            labelRefresh: "Refresh",
            labelDelete: "Delete widget:",
            afterLoad: function() {},
            rtl: !1,
            onChange: function() {},
            onSave: function() {}
            //ajaxnav: $.navAsAjax
        })

        $("#startDate").datetimepicker({minView: 2,autoclose: 1,clearBtn:true,todayBtn: 1});
        $("#endDate").datetimepicker({minView: 2,autoclose: 1,clearBtn:true,todayBtn: 1});
        $("#date1").datetimepicker({startView: 3,minView: 3,autoclose: 1,clearBtn:true,todayBtn: 1});
        var d = new Date();
        var m = d.getMonth()+1 ;
        if(m<10)
            m = "0"+m ;
        var y = d.getFullYear() ;
        var da = y+"-"+m ;
        $("#date1").val(da);
        $("#searchReport").bind("click",function () {
            var variables = {} ;
            var startDate = $("[name='startDate']").val();
            var endDate = $("[name='endDate']").val();
            if(startDate!="" && startDate!=null){
                variables.startDate = startDate ;
            }
            if(endDate!="" && endDate!=null){
                variables.endDate = endDate ;
            }
            $("#report_total_everyday_table").bootstrapTable('refresh',{query:variables});
        })
    })
    var headData = ['呼入总量',
        '呼入接听量',
        '呼出量',
        '呼出接听量',
        '平均通话时长',
        '平均排队时长',
        '平均处理时长',
        '平均震铃时长',
        '通话时长',
        '排队时长'];
    var month = $("#date1").val();
    var d = new Date();
    var m = d.getMonth()+1 ;
    if(m<10)
        m = "0"+m ;
    var y = d.getFullYear() ;
    var da = y+"-"+m ;
    searchCharts(da);
    $("#date1").change(function () {
        var month1 = $("#date1").val();
        searchCharts(month1);
    })
    function searchCharts(m) {
        $.ajax({
            type:"get",
            url:"/report_everyday/"+m,
            dataType : "json" ,
            success:function (data) {
                var chart = echarts.init(document.getElementById('report_everyday'));
                var option = {
                    title: {
                        text:'总体话务量日报表',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            crossStyle: {
                                color: 'red'
                            }
                        }
                    },
                    toolbox: {
                        feature: {
                            mark : {show: true},
                            /*dataView : {show: true, readOnly: false},*/
                            magicType : {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore : {show: true},
                            saveAsImage : {show: true}
                        }
                    },
                    legend: {

                    },
                    xAxis: [
                        {
                            type: 'category',
                            axisPointer: {
                                type: 'shadow'
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '时长(s)',
                            axisLabel: {
                                formatter: '{value}'
                            }
                        },
                        {
                            type: 'value',
                            name: '数量(个)',
                            axisLabel: {
                                formatter: '{value}'
                            }
                        }
                    ],
                }
                var date =  new Array();//日期
                var sumCallIn = new Array();//呼入总量
                var sumSuccessCallIn = new Array();//呼入接听量
                var callOutCount = new Array();
                var successCallOutCount = new Array();
                var avgTalkTime = new Array();
                var avgQueueTime = new Array();
                var avgAfterTime = new Array();
                var avgRingTime = new Array();
                var sumCallInTime = new Array();//通话总时长
                var sumQueueTime = new Array();//排队总时长
                var filedsArray = [sumCallIn,
                    sumSuccessCallIn,
                    callOutCount,
                    successCallOutCount,
                    avgTalkTime,
                    avgQueueTime,
                    avgAfterTime,
                    avgRingTime,
                    sumCallInTime,
                    sumQueueTime]
                for( var i = 0 ; i < data.rows.length ; i++ ){
                    date[i]=data.rows[i].date==undefined?0:data.rows[i].date;//日期
                    sumCallIn[i]=data.rows[i].sumCallIn==undefined?0:data.rows[i].sumCallIn;
                    sumSuccessCallIn[i]=data.rows[i].sumSuccessCallIn==undefined?0:data.rows[i].sumSuccessCallIn;
                    callOutCount[i]=data.rows[i].callOutCount==undefined?0:data.rows[i].callOutCount;
                    successCallOutCount[i]=data.rows[i].successCallOutCount==undefined?0:data.rows[i].successCallOutCount;
                    avgTalkTime[i]=data.rows[i].avgTalkTime==undefined?0:data.rows[i].avgTalkTime;
                    avgQueueTime[i]=data.rows[i].avgQueueTime==undefined?0:data.rows[i].avgQueueTime;
                    avgAfterTime[i]=data.rows[i].avgAfterTime==undefined?0:data.rows[i].avgAfterTime;
                    avgRingTime[i]=data.rows[i].avgRingTime==undefined?0:data.rows[i].avgRingTime;
                    sumCallInTime[i]=data.rows[i].sumCallInTime==undefined?0:data.rows[i].sumCallInTime;
                    sumQueueTime[i]=data.rows[i].sumQueueTime==undefined?0:data.rows[i].sumQueueTime;
                }
                option.legend.data = headData;
                option.legend.y = "bottom";
                var xAxisData = new Array();
                for ( var i = 0; i < data.rows.length; i++ ) {
                    xAxisData[i] = data.rows[i].date.substr(8,2);
                }

                option.xAxis[0].data = xAxisData;
                //初始化 series
                var seriesData = new Array();
                for( var i = 0 ; i < headData.length; i++ ){
                    if( headData[i].indexOf("时长") != -1 ){
                        seriesData[i] = {name:headData[i],type:"bar",yAxisIndex: 0,data:filedsArray[i]}
                    }else{
                        seriesData[i] = {name:headData[i],type:"line",yAxisIndex: 1,data:filedsArray[i]}
                    }
                }
                option.series = seriesData;
                // 为echarts对象加载数据
                chart.setOption(option);
            }
        });
    }
</script>
</body>
</html>